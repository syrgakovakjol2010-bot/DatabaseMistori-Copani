<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M.C. ENTERPRISE SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–´ (CSS)
           ========================================= */
        :root {
            --bg: #000000;
            --sidebar: #050505;
            --card: #0f0f0f;
            --input: #151515;
            --border: #222;
            --text-main: #ffffff;
            --text-dim: #888888;
            
            --gold: #FFD700;
            --green: #00E676;
            --red: #FF1744;
            --blue: #2979FF;
            --purple: #D500F9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- –ó–ê–°–¢–ê–í–ö–ê (SPLASH SCREEN) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .loader-ring {
            width: 50px; height: 50px; border: 4px solid #222;
            border-top: 4px solid #fff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .splash-text { letter-spacing: 5px; font-weight: 900; animation: pulse 2s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* --- –í–•–û–î –í –°–ò–°–¢–ï–ú–£ --- */
        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            width: 100%; max-width: 400px; background: var(--card);
            border: 1px solid var(--border); padding: 40px;
            border-radius: 24px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        .auth-logo { font-size: 3rem; font-weight: 900; letter-spacing: 8px; margin-bottom: 5px; }
        
        input, textarea, select {
            width: 100%; padding: 16px; margin: 10px 0;
            background: var(--input); border: 1px solid #333;
            color: #fff; border-radius: 12px; font-size: 16px;
            transition: 0.3s;
        }
        input:focus { border-color: #fff; background: #000; }

        .btn {
            width: 100%; padding: 16px; border-radius: 12px;
            font-weight: 800; border: none; cursor: pointer;
            text-transform: uppercase; margin-top: 10px; font-size: 14px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #fff; color: #000; }
        .btn-outline { background: transparent; border: 1px solid #333; color: var(--text-dim); }
        
        /* --- –ò–ù–¢–ï–†–§–ï–ô–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø --- */
        #app-layout { display: none; height: 100%; width: 100%; }

        /* –°–ê–ô–î–ë–ê–† (–î–ª—è –ö–æ–º–ø—å—é—Ç–µ—Ä–∞) */
        .sidebar {
            width: 280px; background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 30px;
        }
        .brand { font-size: 1.5rem; font-weight: 900; letter-spacing: 3px; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-items { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .menu-link {
            background: transparent; border: none; color: var(--text-dim);
            padding: 14px 18px; border-radius: 12px; text-align: left;
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .menu-link.active, .menu-link:hover { background: #111; color: #fff; }

        /* –ì–õ–ê–í–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .top-header {
            height: 70px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
        }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 38px; height: 38px; background: #222;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-weight: bold; border: 1px solid #333;
        }

        .scroll-container { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 100px; }

        /* –ö–ê–†–¢–û–ß–ö–ò –ò –≠–õ–ï–ú–ï–ù–¢–´ */
        .card {
            background: var(--card); border: 1px solid var(--border);
            padding: 22px; border-radius: 18px; margin-bottom: 16px;
            position: relative; transition: 0.3s;
        }
        .card:hover { border-color: #444; }

        .price-badge {
            position: absolute; top: 22px; right: 22px;
            color: var(--gold); border: 1px solid var(--gold);
            padding: 4px 10px; border-radius: 8px; font-weight: 800;
        }

        .ref-box {
            background: #080808; border: 1px dashed #333;
            padding: 12px; border-radius: 10px; font-size: 0.8rem;
            color: var(--blue); margin-top: 10px; word-break: break-all;
        }

        .status-pill {
            display: inline-block; padding: 4px 10px; border-radius: 6px;
            font-size: 0.65rem; text-transform: uppercase; font-weight: bold;
            border: 1px solid #333; margin-top: 12px;
        }

        /* –ß–ê–¢ */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-feed { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 16px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg-mine { align-self: flex-end; background: #fff; color: #000; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: #1a1a1a; border: 1px solid #333; border-bottom-left-radius: 4px; }
        .msg-meta { font-size: 0.65rem; opacity: 0.6; margin-bottom: 4px; display: block; }
        .chat-input-area { display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border); background: #000; }

        /* –ö–û–ú–ê–ù–î–ê */
        .warn-dots { display: flex; gap: 4px; margin-top: 8px; }
        .dot { width: 8px; height: 8px; background: #222; border-radius: 50%; }
        .dot.active { background: var(--red); box-shadow: 0 0 8px var(--red); }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (–ú–û–ë–ò–õ–¨–ù–û–ï) */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; width: 100%;
            background: rgba(8,8,8,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            justify-content: space-around; padding: 12px 0; z-index: 2000;
        }
        .mob-btn {
            background: none; border: none; color: #555;
            font-size: 0.6rem; font-weight: bold; display: flex;
            flex-direction: column; align-items: center; gap: 5px;
        }
        .mob-btn.active { color: #fff; }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 12px 30px; border-radius: 50px;
            font-weight: 800; z-index: 10000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .top-header { padding: 0 15px; }
            .scroll-container { padding: 15px; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="loader-ring"></div>
        <div class="splash-text">MISTORI COPANI</div>
    </div>

    <div id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div id="auth-container">
        <div class="auth-box">
            <h1 class="auth-logo">M.C.</h1>
            <p style="color:#666; font-size:0.75rem; letter-spacing:2px; margin-bottom:30px;">ENTERPRISE SYSTEM v35</p>
            
            <input type="text" id="ph" placeholder="–ù–æ–º–µ—Ä (705163333)">
            <input type="password" id="ps" placeholder="–ü–∞—Ä–æ–ª—å">
            
            <button class="btn btn-primary" onclick="window.appLogin()">–í–û–ô–¢–ò</button>
            <p id="login-error" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="app-layout">
        <div class="sidebar">
            <div class="brand">
                <div style="width:30px; height:30px; background:#fff; border-radius:6px;"></div>
                MISTORI
            </div>
            <div class="menu-items">
                <button class="menu-link active" id="d-orders" onclick="window.nav('orders')">üì¶ –ó–ê–ö–ê–ó–´</button>
                <button class="menu-link" id="d-chat" onclick="window.nav('chat')">üí¨ –ß–ê–¢</button>
                <button class="menu-link" id="d-team" onclick="window.nav('team')">üë• –ö–û–ú–ê–ù–î–ê</button>
                <button class="menu-link" id="d-fin" onclick="window.nav('fin')">üìä –ö–ê–°–°–ê</button>
                <button class="menu-link" id="d-add" onclick="window.nav('add')" style="color:var(--green)">‚ûï –°–û–ó–î–ê–¢–¨</button>
            </div>
            <button class="menu-link" onclick="location.reload()" style="color:var(--red); margin-top:auto;">–í–´–•–û–î</button>
        </div>

        <div class="main-content">
            <div class="top-header">
                <div class="user-profile">
                    <div class="avatar" id="u-ava">A</div>
                    <div>
                        <b id="u-name" style="display:block; line-height:1;">...</b>
                        <small id="u-role" style="font-size:0.6rem; color:var(--green); text-transform:uppercase;">...</small>
                    </div>
                </div>
                <div style="font-weight:900; opacity:0.2; letter-spacing:3px;">ONLINE</div>
            </div>

            <div class="scroll-container" id="view"></div>
        </div>

        <div class="mobile-nav">
            <button class="mob-btn active" id="m-orders" onclick="window.nav('orders')">üì¶<br>–ó–ê–ö–ê–ó–´</button>
            <button class="mob-btn" id="m-chat" onclick="window.nav('chat')">üí¨<br>–ß–ê–¢</button>
            <button class="mob-btn" id="m-add" onclick="window.nav('add')" style="color:var(--green); transform:scale(1.2);">‚ûï</button>
            <button class="mob-btn" id="m-team" onclick="window.nav('team')">üë•<br>–õ–Æ–î–ò</button>
            <button class="mob-btn" id="m-fin" onclick="window.nav('fin')">üìä<br>–ö–ê–°–°–ê</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –°–í–û–ò –ö–õ–Æ–ß–ò –°–Æ–î–ê ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "–í–°–¢–ê–í–¨_–°–Æ–î–ê_API_KEY",
            authDomain: "mistori-copani.firebaseapp.com",
            databaseURL: "https://mistori-copani-default-rtdb.firebaseio.com",
            projectId: "mistori-copani",
            storageBucket: "mistori-copani.appspot.com",
            messagingSenderId: "–í–°–¢–ê–í–¨_ID",
            appId: "–í–°–¢–ê–í–¨_APP_ID"
        };

        // –ó–∞–ø—É—Å–∫
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ME = null;
        let DATA = { orders: {}, users: {}, chat: {} };

        // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
        window.appLogin = async () => {
            const p = document.getElementById('ph').value.trim();
            const s = document.getElementById('ps').value.trim();
            const err = document.getElementById('login-error');

            if(!p || !s) { err.innerText = "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ"; return; }

            // –ñ–µ—Å—Ç–∫–∏–π –≤—Ö–æ–¥ –¥–ª—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∞ –∏ –ú–µ–Ω–µ–¥–∂–µ—Ä–∞
            if(p === '705163333' && s === 'admin123') return loginSuccess({name:"–ê–∫–∂–æ–ª", phone:p, role:"director", xp:999});
            if(p === '777800603' && s === 'admin2') return loginSuccess({name:"–°–µ–∑–∏–º", phone:p, role:"manager", xp:10});

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const snap = await get(child(ref(db), `users/${p}`));
            if (snap.exists()) {
                const user = snap.val();
                if(user.pass === s) loginSuccess(user);
                else err.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
            } else {
                // –ê–≤—Ç–æ-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞
                if(confirm("–í–∞—Å –Ω–µ—Ç –≤ –±–∞–∑–µ. –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) {
                    const name = prompt("–í–∞—à–µ –ò–º—è:");
                    if(name) {
                        const newUser = { name, phone: p, pass: s, role: "programmer", xp: 0, warns: 0 };
                        loginSuccess(newUser);
                    }
                }
            }
        };

        function loginSuccess(user) {
            ME = user;
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ (—á—Ç–æ–±—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä –≤–∏–¥–µ–ª)
            update(ref(db, 'users/' + ME.phone), ME);
            
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('u-name').innerText = ME.name;
            document.getElementById('u-role').innerText = ME.role;
            document.getElementById('u-ava').innerText = ME.name[0];
            
            window.nav('orders');
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        window.nav = (screen) => {
            const v = document.getElementById('view');
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.menu-link, .mob-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById('d-'+screen)) document.getElementById('d-'+screen).classList.add('active');
            if(document.getElementById('m-'+screen)) document.getElementById('m-'+screen).classList.add('active');
            
            v.innerHTML = '';
            
            if(screen === 'orders') renderOrders(v);
            if(screen === 'chat') renderChat(v);
            if(screen === 'team') renderTeam(v);
            if(screen === 'fin') renderFin(v);
            if(screen === 'add') renderAdd(v);
        };

        // --- –≠–ö–†–ê–ù–´ ---
        function renderOrders(el) {
            el.innerHTML = '<div id="list"></div>';
            const list = document.getElementById('list');
            const arr = Object.entries(DATA.orders || {}).reverse();
            
            if(arr.length === 0) { list.innerHTML = '<center style="margin-top:50px; color:#555">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</center>'; return; }

            arr.forEach(([k, o]) => {
                if(o.status === 'archive') return;
                
                let btns = '';
                if(o.status === 'new') btns = `<button class="btn btn-primary" onclick="window.upd('${k}','work')">–í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£</button>`;
                if(o.status === 'work') btns = `<button class="btn btn-primary" style="background:var(--gold)" onclick="window.upd('${k}','done')">–ó–ê–í–ï–†–®–ò–¢–¨</button>`;
                
                list.innerHTML += `
                    <div class="card" style="${o.status==='reject'?'opacity:0.5':''}">
                        <div class="price-badge">${o.price} —Å</div>
                        <h3 style="margin:0">${o.client}</h3>
                        <p style="color:#aaa; font-size:0.9rem; margin:10px 0;">${o.desc}</p>
                        ${o.ref ? `<div class="ref-box">üîó ${o.ref}</div>` : ''}
                        
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="status-pill" style="border-color:${getColor(o.status)}; color:${getColor(o.status)}">${o.status}</span>
                            <small style="color:#555">${formatDate(o.date)}</small>
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            ${btns}
                            ${ME.role !== 'programmer' && o.status !== 'reject' ? `<button class="btn btn-outline" style="color:var(--red)" onclick="window.upd('${k}','reject')">–û–¢–ö–ê–ó</button>` : ''}
                            ${ME.role === 'director' ? `<button class="btn btn-outline" style="width:auto;" onclick="window.upd('${k}','archive')">DEL</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function renderChat(el) {
            el.innerHTML = `
                <div class="chat-container">
                    <div class="chat-feed" id="feed"></div>
                    <div class="chat-input-area">
                        <input id="chat-msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                        <button class="btn btn-primary" style="width:60px; margin:0" onclick="window.send()">></button>
                    </div>
                </div>
            `;
            setTimeout(drawChat, 100);
        }

        function drawChat() {
            const f = document.getElementById('feed');
            if(!f) return;
            f.innerHTML = '';
            Object.values(DATA.chat || {}).forEach(m => {
                const me = m.user === ME.name;
                f.innerHTML += `
                    <div class="msg ${me ? 'msg-mine' : 'msg-other'}">
                        <span class="msg-meta">${m.user} (${m.role})</span>
                        ${m.text}
                    </div>
                `;
            });
            f.scrollTop = f.scrollHeight;
        }

        function renderTeam(el) {
            el.innerHTML = '<h3>–°–û–¢–†–£–î–ù–ò–ö–ò</h3>';
            Object.values(DATA.users || {}).forEach(u => {
                let dots = '';
                for(let i=1; i<=3; i++) dots += `<div class="dot ${u.warns>=i?'active':''}"></div>`;
                
                el.innerHTML += `
                    <div class="card" style="display:flex; align-items:center; gap:15px;">
                        <div class="avatar" style="width:45px; height:45px; font-size:1.2rem;">${u.name[0]}</div>
                        <div style="flex:1">
                            <b>${u.name}</b> <small style="color:#666">(${u.role})</small><br>
                            <small style="color:var(--green)">XP: ${u.xp || 0}</small>
                            <div class="warn-dots">${dots}</div>
                        </div>
                        ${ME.role === 'director' && u.phone !== ME.phone ? `
                            <button onclick="window.warn('${u.phone}')" style="background:var(--red); color:#fff; border:none; padding:6px 10px; border-radius:6px; font-weight:bold; font-size:0.65rem;">WARN</button>
                        ` : ''}
                    </div>
                `;
            });
        }

        function renderFin(el) {
            const done = Object.values(DATA.orders || {}).filter(o => 
