<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M.C. SYSTEM | v25.0</title>
    <style>
        /* =========================================
           1. –ù–ê–°–¢–†–û–ô–ö–ò –î–ò–ó–ê–ô–ù–ê (CSS)
           ========================================= */
        :root {
            --bg: #000000;
            --sidebar: #050505;
            --card: #0a0a0a;
            --border: #1f1f1f;
            --text: #ffffff;
            --text-gray: #888888;
            --gold: #FFD700;
            --green: #00FF88;
            --red: #FF4444;
            --blue: #0088FF;
            --purple: #9D00FF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- –ó–ê–°–¢–ê–í–ö–ê (SPLASH) --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; transition: opacity 0.5s;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--text); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- –≠–ö–†–ê–ù–´ –í–•–û–î–ê --- */
        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            width: 100%; max-width: 360px; background: var(--card);
            border: 1px solid var(--border); padding: 40px 30px;
            border-radius: 20px; text-align: center;
        }
        .auth-title { font-size: 2.5rem; font-weight: 900; letter-spacing: 5px; margin: 0; }
        .auth-sub { color: var(--text-gray); font-size: 0.7rem; text-transform: uppercase; margin-bottom: 30px; letter-spacing: 2px; }

        input, textarea, select {
            width: 100%; padding: 15px; margin: 8px 0; background: #111;
            border: 1px solid #333; color: #fff; border-radius: 12px; font-size: 16px;
        }
        input:focus { border-color: #fff; }

        .btn {
            width: 100%; padding: 15px; margin-top: 10px; border-radius: 12px;
            font-weight: bold; border: none; cursor: pointer; text-transform: uppercase;
            font-size: 14px; transition: 0.2s;
        }
        .btn-primary { background: #fff; color: #000; }
        .btn-outline { background: transparent; border: 1px solid #333; color: var(--text-gray); }
        .btn-danger { background: rgba(255,0,0,0.1); color: var(--red); margin-top: 30px; font-size: 0.7rem; }

        /* --- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #app-layout { display: none; height: 100%; width: 100%; }

        /* –°–∞–π–¥–±–∞—Ä (–ü–ö) */
        .sidebar {
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 30px;
        }
        .brand { font-size: 1.5rem; font-weight: 900; letter-spacing: 3px; margin-bottom: 40px; }
        .menu-list { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .menu-btn {
            background: transparent; border: none; color: var(--text-gray);
            padding: 12px; text-align: left; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; border-radius: 10px; transition: 0.2s;
        }
        .menu-btn.active, .menu-btn:hover { background: #111; color: #fff; }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .main-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .top-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
        }
        .user-info b { display: block; font-size: 0.9rem; }
        .user-info span { font-size: 0.6rem; color: var(--green); text-transform: uppercase; }
        
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (–¢–µ–ª–µ—Ñ–æ–Ω) */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; width: 100%;
            background: #080808; border-top: 1px solid var(--border);
            justify-content: space-around; padding: 12px 0; z-index: 1000;
        }
        .mob-btn {
            background: none; border: none; color: #555;
            font-size: 0.6rem; font-weight: bold; display: flex;
            flex-direction: column; align-items: center; gap: 4px;
        }
        .mob-btn.active { color: #fff; }

        /* --- –ö–ê–†–¢–û–ß–ö–ò –ò –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .card {
            background: var(--card); border: 1px solid var(--border);
            padding: 20px; border-radius: 16px; margin-bottom: 15px; position: relative;
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-num { font-size: 1.5rem; font-weight: 900; display: block; margin-top: 5px; }
        
        .price-tag {
            position: absolute; top: 20px; right: 20px; color: var(--gold);
            font-weight: bold; border: 1px solid var(--gold);
            padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;
        }
        
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 0.65rem; text-transform: uppercase; font-weight: bold;
            border: 1px solid #333; margin-top: 10px;
        }
        
        /* –ß–ê–¢ */
        .chat-wrap { display: flex; flex-direction: column; height: 100%; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; }
        .msg-me { align-self: flex-end; background: #fff; color: #000; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background: #1a1a1a; border: 1px solid #333; border-bottom-left-radius: 2px; }
        .msg-info { font-size: 0.6rem; opacity: 0.6; margin-bottom: 2px; }
        .chat-input { display: flex; padding: 10px; border-top: 1px solid var(--border); gap: 10px; }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
        }

        .hidden { display: none !important; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 10px 20px; border-radius: 30px;
            font-weight: bold; z-index: 9999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="splash">
        <div class="loader"></div>
        <div class="auth-title" style="font-size:1.5rem;">MISTORI COPANI</div>
    </div>

    <div id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div id="auth-container">
        <div class="auth-box" id="login-block">
            <h1 class="auth-title">M.C.</h1>
            <p class="auth-sub">BOSS SYSTEM v25</p>
            <input type="text" id="l-phone" placeholder="705 163 333">
            <input type="password" id="l-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-primary" onclick="authLogin()">–í–û–ô–¢–ò</button>
            <button class="btn btn-outline" onclick="toggleAuth(true)">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
            <button class="btn btn-danger" onclick="hardReset()">–°–ë–†–û–°–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï</button>
        </div>

        <div class="auth-box hidden" id="reg-block">
            <h2>–ù–û–í–´–ô ID</h2>
            <input type="text" id="r-name" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
            <input type="text" id="r-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="password" id="r-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button class="btn btn-primary" onclick="authRegister()">–°–û–ó–î–ê–¢–¨</button>
            <button class="btn btn-outline" onclick="toggleAuth(false)">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="app-layout">
        <div class="sidebar">
            <div class="brand">MISTORI</div>
            <div class="menu-list">
                <button class="menu-btn active" id="d-orders" onclick="nav('orders')">üì¶ –ó–ê–ö–ê–ó–´</button>
                <button class="menu-btn" id="d-chat" onclick="nav('chat')">üí¨ –ß–ê–¢</button>
                <button class="menu-btn" id="d-team" onclick="nav('team')">üë• –ö–û–ú–ê–ù–î–ê</button>
                <button class="menu-btn" id="d-add" onclick="nav('add')">‚ûï –°–û–ó–î–ê–¢–¨</button>
                <button class="menu-btn" id="d-fin" onclick="nav('fin')">üìä –ö–ê–°–°–ê</button>
            </div>
            <button class="menu-btn" style="color:var(--red)" onclick="location.reload()">–í–´–•–û–î</button>
        </div>

        <div class="main-area">
            <div class="top-header">
                <div class="user-info">
                    <b id="u-name">–ò–º—è</b>
                    <span id="u-role">–†–û–õ–¨</span>
                </div>
                <div style="font-weight:900; opacity:0.3; letter-spacing:2px;">M.C.</div>
            </div>

            <div class="content-scroll" id="view-container">
                </div>
        </div>

        <div class="mobile-nav">
            <button class="mob-btn active" id="m-orders" onclick="nav('orders')">üì¶<br>–ó–ê–ö–ê–ó–´</button>
            <button class="mob-btn" id="m-chat" onclick="nav('chat')">üí¨<br>–ß–ê–¢</button>
            <button class="mob-btn" id="m-team" onclick="nav('team')">üë•<br>–õ–Æ–î–ò</button>
            <button class="mob-btn" id="m-add" onclick="nav('add')">‚ûï<br>–ù–û–í–´–ô</button>
            <button class="mob-btn" id="m-fin" onclick="nav('fin')">üìä<br>–ö–ê–°–°–ê</button>
        </div>
    </div>

    <script>
        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
        const DB_NAME = 'mc_boss_v25';
        let DB = JSON.parse(localStorage.getItem(DB_NAME)) || {
            users: [
                { name: "–°–µ–∑–∏–º", phone: "777800603", pass: "admin2", role: "manager", xp: 5, warns: 0 }
            ],
            orders: [],
            chat: [
                { user: "System", text: "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Mistori Copani!", role: "system", time: "00:00" }
            ]
        };

        let me = null; // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
            }, 1000);
        };

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        function authLogin() {
            const p = document.getElementById('l-phone').value.trim();
            const s = document.getElementById('l-pass').value.trim();

            if (p === '705163333' && s === 'admin123') {
                me = { name: "–ê–∫–∂–æ–ª", phone: p, role: "director", xp: 9999, warns: 0 };
                openApp();
            } else {
                let user = DB.users.find(u => u.phone === p && u.pass === s);
                if (user) { me = user; openApp(); } 
                else { showToast('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!'); }
            }
        }

        function authRegister() {
            const n = document.getElementById('r-name').value.trim();
            const p = document.getElementById('r-phone').value.trim();
            const s = document.getElementById('r-pass').value.trim();

            if (!n || !p || !s) return showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            if (DB.users.find(u => u.phone === p) || p === '705163333') return showToast('–ù–æ–º–µ—Ä –∑–∞–Ω—è—Ç');

            DB.users.push({ name: n, phone: p, pass: s, role: "programmer", xp: 0, warns: 0 });
            saveData();
            showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ.');
            toggleAuth(false);
        }

        function openApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('u-name').innerText = me.name;
            document.getElementById('u-role').innerText = me.role;
            nav('orders');
        }

        function toggleAuth(showReg) {
            document.getElementById('login-block').classList.toggle('hidden', showReg);
            document.getElementById('reg-block').classList.toggle('hidden', !showReg);
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function nav(screen) {
            const container = document.getElementById('view-container');
            
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.menu-btn, .mob-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById('d-'+screen)) document.getElementById('d-'+screen).classList.add('active');
            if(document.getElementById('m-'+screen)) document.getElementById('m-'+screen).classList.add('active');

            if (screen === 'orders') renderOrders(container);
            if (screen === 'chat') renderChat(container);
            if (screen === 'team') renderTeam(container);
            if (screen === 'add') renderAdd(container);
            if (screen === 'fin') renderFin(container);
        }

        // --- –≠–ö–†–ê–ù: –ó–ê–ö–ê–ó–´ ---
        function renderOrders(container) {
            const active = DB.orders.filter(o => o.status === 'work').length;
            const cash = DB.orders.filter(o => o.status === 'done').reduce((a,b) => a + Number(b.price), 0);

            let html = `
                <div class="stat-grid">
                    <div class="stat-box"><small>–í –†–ê–ë–û–¢–ï</small><span class="stat-num">${active}</span></div>
                    <div class="stat-box" style="border-color:var(--gold)"><small>–ü–†–ò–ë–´–õ–¨</small><span class="stat-num" style="color:var(--gold)">${cash} —Å</span></div>
                </div>
                <h3>–ü–†–û–ï–ö–¢–´</h3>
            `;

            const list = DB.orders.filter(o => o.status !== 'archive').reverse();
            if (list.length === 0) html += `<p style="text-align:center; color:#444; margin-top:50px;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>`;

            list.forEach((o) => {
                let idx = DB.orders.indexOf(o);
                let statusColor = o.status === 'work' ? 'var(--blue)' : (o.status === 'done' ? '#fff' : 'var(--green)');
                if (o.status === 'reject') statusColor = 'var(--red)';

                html += `
                    <div class="card" style="${o.status==='reject' ? 'opacity:0.5' : ''}">
                        <span class="price-tag">${o.price} —Å</span>
                        <div style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;">${o.client}</div>
                        <div style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">${o.desc}</div>
                        ${o.ref ? `<div style="background:#111; padding:8px; border-radius:6px; font-size:0.8rem; color:var(--blue); margin-bottom:10px;">üîó ${o.ref}</div>` : ''}
                        
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="status-badge" style="color:${statusColor}; border-color:${statusColor}">${o.status}</span>
                            <small style="color:#555">${o.date}</small>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                            ${o.status === 'new' ? `<button class="btn btn-primary" style="padding:10px; flex:1;" onclick="setStatus(${idx}, 'work')">–í–ó–Ø–¢–¨</button>` : ''}
                            ${o.status === 'work' ? `<button class="btn btn-primary" style="background:var(--gold); padding:10px; flex:1;" onclick="setStatus(${idx}, 'done')">–ó–ê–í–ï–†–®–ò–¢–¨</button>` : ''}
                            ${['director','manager'].includes(me.role) ? `<button class="btn btn-outline" style="padding:10px; color:var(--red);" onclick="setStatus(${idx}, 'reject')">–û–¢–ö–ê–ó</button>` : ''}
                            ${me.role === 'director' ? `<button class="btn btn-outline" style="padding:10px;" onclick="setStatus(${idx}, 'archive')">–£–î–ê–õ–ò–¢–¨</button>` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- –≠–ö–†–ê–ù: –ß–ê–¢ ---
        function renderChat(container) {
            container.innerHTML = `
                <div class="chat-wrap">
                    <div class="chat-msgs" id="chat-feed"></div>
                    <div class="chat-input">
                        <input id="msg-text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
                        <button class="btn btn-primary" style="width:60px; margin:0;" onclick="sendMsg()">></button>
                    </div>
                </div>
            `;
            updateChatFeed();
        }

        function updateChatFeed() {
            const feed = document.getElementById('chat-feed');
            if(!feed) return;
            feed.innerHTML = '';
            
            DB.chat.forEach((m, i) => {
                let isMe = m.user === me.name;
                feed.innerHTML += `
                    <div class="msg ${isMe ? 'msg-me' : 'msg-other'}">
                        <div class="msg-info">${m.user} (${m.role}) ${m.time}</div>
                        ${m.text}
                        ${me.role === 'director' ? `<div onclick="delMsg(${i})" style="font-size:0.6rem; color:red; margin-top:5px; cursor:pointer;">—É–¥–∞–ª–∏—Ç—å</div>` : ''}
                    </div>
                `;
            });
            feed.scrollTop = feed.scrollHeight;
        }

        function sendMsg() {
            const txt = document.getElementById('msg-text').value.trim();
            if(!txt) return;
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            DB.chat.push({ user: me.name, role: me.role, text: txt, time: time });
            saveData();
            document.getElementById('msg-text').value = '';
            updateChatFeed();
        }

        function delMsg(i) {
            DB.chat.splice(i, 1);
            saveData();
            updateChatFeed();
        }

        // --- –≠–ö–†–ê–ù: –ö–û–ú–ê–ù–î–ê ---
        function renderTeam(container) {
            let html = `<h3>–°–û–¢–†–£–î–ù–ò–ö–ò</h3>`;
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ XP
            let sorted = [...DB.users].sort((a,b) => (b.xp||0) - (a.xp||0));

            sorted.forEach(u => {
                let rank = u.xp >= 10 ? 'SENIOR' : (u.xp >= 3 ? 'MIDDLE' : 'JUNIOR');
                let rankColor = u.xp >= 10 ? 'var(--purple)' : (u.xp >= 3 ? 'var(--blue)' : '#333');
                
                let warnings = '';
                for(let i=1; i<=3; i++) {
                    warnings += `<span style="display:inline-block; width:8px; height:8px; background:${u.warns>=i?'red':'#333'}; border-radius:50%; margin-right:4px;"></span>`;
                }

                html += `
                    <div class="card" style="display:flex; align-items:center; gap:15px;">
                        <div style="wi
