<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.B. ULTIMATE SYSTEM</title>
    <style>
        /* --- 1. –î–ò–ó–ê–ô–ù –ò –°–¢–ò–õ–ò --- */
        body { background-color: #000000; color: #ffffff; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* –í—Ö–æ–¥ */
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; background: #000; }
        .login-box { width: 320px; border: 1px solid #333; padding: 40px; text-align: center; background: #050505; box-shadow: 0 0 30px rgba(255,255,255,0.05); border-radius: 8px; }
        input { width: 100%; box-sizing: border-box; background: #111; border: 1px solid #444; color: #fff; padding: 12px; margin: 8px 0; outline: none; border-radius: 4px; }
        input:focus { border-color: #fff; background: #000; }
        button { cursor: pointer; padding: 12px; text-transform: uppercase; font-weight: bold; width: 100%; border: none; letter-spacing: 1px; border-radius: 4px; margin-top: 10px; }
        .btn-primary { background: white; color: black; }
        .btn-outline { background: transparent; color: #888; border: 1px solid #333; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #app { display: none; height: 100%; }
        .sidebar { width: 260px; border-right: 1px solid #222; padding: 20px; background: #080808; display: flex; flex-direction: column; gap: 10px; }
        .content { flex: 1; padding: 20px; overflow-y: auto; background: #000; position: relative; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .user-profile { display: flex; align-items: center; gap: 15px; padding-bottom: 20px; border-bottom: 1px solid #222; margin-bottom: 10px; }
        .avatar { width: 45px; height: 45px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; border: 1px solid #444; }
        
        /* –ú–µ–Ω—é */
        .menu-btn { background: transparent; color: #aaa; text-align: left; padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .menu-btn:hover, .menu-btn.active { background: #1a1a1a; color: white; border-left: 3px solid white; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #080808; border: 1px solid #222; padding: 15px; text-align: center; border-radius: 8px; }
        .stat-num { font-size: 1.5rem; font-weight: bold; display: block; margin-top: 5px; }
        .money-text { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-chip { background: #111; border: 1px solid #333; color: #888; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; width: auto; margin: 0; }
        .filter-chip.active { background: #fff; color: #000; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ */
        .order-card { background: #0a0a0a; border: 1px solid #222; padding: 20px; margin-bottom: 15px; border-radius: 8px; position: relative; }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .price-tag { color: #ffd700; border: 1px solid #ffd700; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        
        /* –ó–∞–º–µ—Ç–∫–∏ */
        .notes-area { background: #050505; border: 1px dashed #333; padding: 10px; margin-top: 15px; border-radius: 4px; font-size: 0.85rem; color: #aaa; }
        .add-note { color: #00ff00; cursor: pointer; font-size: 0.75rem; margin-top: 5px; display: inline-block; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Toast) */
        #toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
        .toast { background: #fff; color: #000; padding: 12px 20px; border-radius: 4px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* –°—Ç–∞—Ç—É—Å—ã –∏ –†–∞–Ω–≥–∏ */
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; border: 1px solid #333; }
        .st-free { color: #00ff00; border-color: #00ff00; }
        .st-work { color: yellow; border-color: yellow; }
        .st-closed { color: red; border-color: red; }
        .deadline-hot { color: #ff4444; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* –¶–≤–µ—Ç–∞ —Ä–∞–Ω–≥–æ–≤ */
        .rank-badge { padding: 2px 6px; font-size: 0.7rem; border-radius: 3px; margin-left: 5px; }
        .rank-jun { background: #333; color: #aaa; border: 1px solid #555; }
        .rank-mid { background: #0000ff; color: white; border: 1px solid #5555ff; }
        .rank-sen { background: #ff00ff; color: white; border: 1px solid #ff55ff; box-shadow: 0 0 5px #ff00ff; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h1 style="margin-bottom: 5px; letter-spacing: 3px;">S.A.B.</h1>
            <p style="color: #666; font-size: 0.8rem; margin-bottom: 30px;">ULTIMATE STUDIO v7.0</p>
            <input type="text" id="ph" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="password" id="ps" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-primary" onclick="tryLogin()">–í–û–ô–¢–ò</button>
            <button class="btn-outline" onclick="showReg()">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        </div>
    </div>

    <div id="reg-screen" class="login-wrapper" style="display:none;">
        <div class="login-box">
            <h2>–ù–û–í–´–ô –°–û–¢–†–£–î–ù–ò–ö</h2>
            <input type="text" id="r-name" placeholder="–ò–º—è">
            <input type="text" id="r-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
            <input type="password" id="r-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-primary" onclick="doReg()">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
            <button class="btn-outline" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="app">
        <div class="sidebar">
            <div class="user-profile">
                <div class="avatar" id="u-avatar">?</div>
                <div>
                    <h3 id="u-name" style="margin:0; font-size:1rem;">Name</h3>
                    <p id="u-role" style="margin:0; font-size:0.8rem; color:#888;">Role</p>
                </div>
            </div>
            
            <button class="menu-btn active" onclick="setPage('orders')">üìÅ –ó–ê–ö–ê–ó–´</button>
            <button class="menu-btn" onclick="setPage('staff')">üë• –ö–û–ú–ê–ù–î–ê</button>
            <button class="menu-btn" id="btn-add" style="display:none; color:#00ff00; border:1px solid #00ff00;" onclick="renderAddOrder()">+ –ù–û–í–´–ô –ó–ê–ö–ê–ó</button>
            
            <div style="margin-top:auto;">
                <button class="menu-btn" onclick="downloadBackup()" style="font-size:0.8rem; color:#666;">üíæ –°–ö–ê–ß–ê–¢–¨ –ë–ê–ó–£</button>
                <button class="menu-btn" onclick="logout()" style="color:#ff4444;">–í–´–•–û–î</button>
            </div>
        </div>

        <div class="content">
            <div class="stat-grid">
                <div class="stat-card">–°–í–û–ë–û–î–ù–û <span class="stat-num" id="s-free">0</span></div>
                <div class="stat-card">–í –†–ê–ë–û–¢–ï <span class="stat-num" id="s-work">0</span></div>
                <div class="stat-card">–ó–ê–ö–†–´–¢–û <span class="stat-num" id="s-closed">0</span></div>
                <div class="stat-card" style="border-color: #ffd700;">–ö–ê–°–°–ê <span class="stat-num money-text" id="s-money">0</span></div>
            </div>

            <div id="main-view"></div>
        </div>
    </div>

    <script>
        /* --- 1. –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò –ù–ê–°–¢–†–û–ô–ö–ò --- */
        let DB = JSON.parse(localStorage.getItem('sab_db_ultimate')) || { 
            users: [
                { name: "–°–æ–ª—Ç–æ", phone: "700000000", pass: "1234", role: "manager", xp: 5 } 
            ], 
            orders: [] 
        };
        let currentUser = null;
        let currentFilter = 'all';

        /* --- 2. –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê --- */
        function tryLogin() {
            const ph = document.getElementById('ph').value.trim();
            const ps = document.getElementById('ps').value.trim();

            if (ph === '705163333' && ps === 'admin123') {
                currentUser = { name: '–°.–ê.–ë', role: 'director', phone: '705163333', xp: 9999 };
                enterApp(); return;
            }

            let found = DB.users.find(u => u.phone === ph && u.pass === ps);
            if (found) { currentUser = found; enterApp(); } 
            else { showToast('‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error'); }
        }

        function enterApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            document.getElementById('u-name').innerText = currentUser.name;
            document.getElementById('u-role').innerText = currentUser.role.toUpperCase();
            document.getElementById('u-avatar').innerText = currentUser.name[0];
            
            if (['director', 'manager'].includes(currentUser.role)) {
                document.getElementById('btn-add').style.display = 'flex';
            }
            updateStats();
            renderOrders();
        }

        /* --- 3. –ó–ê–ö–ê–ó–´ --- */
        function renderOrders(filter = 'all', search = '') {
            currentFilter = filter;
            const view = document.getElementById('main-view');
            
            // –®–∞–ø–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–æ–∏—Å–∫–æ–º
            view.innerHTML = `
                <div class="filters">
                    <button class="filter-chip ${filter==='all'?'active':''}" onclick="renderOrders('all')">–í—Å–µ</button>
                    <button class="filter-chip ${filter==='free'?'active':''}" onclick="renderOrders('free')">–°–≤–æ–±–æ–¥–Ω—ã–µ</button>
                    <button class="filter-chip ${filter==='process'?'active':''}" onclick="renderOrders('process')">–í —Ä–∞–±–æ—Ç–µ</button>
                    <button class="filter-chip ${filter==='closed'?'active':''}" onclick="renderOrders('closed')">–ì–æ—Ç–æ–≤—ã–µ</button>
                    <button class="filter-chip ${filter==='archived'?'active':''}" onclick="renderOrders('archived')">–ê—Ä—Ö–∏–≤</button>
                </div>
                <input style="margin-bottom:20px;" placeholder="üîç –ü–æ–∏—Å–∫ (–∫–ª–∏–µ–Ω—Ç, –æ–ø–∏—Å–∞–Ω–∏–µ)..." onkeyup="renderOrders('${filter}', this.value)" value="${search}">
            `;

            let list = DB.orders.filter(o => {
                let sMatch = (filter === 'all' && o.status !== 'archived') || (o.status === filter);
                let tMatch = o.client.toLowerCase().includes(search.toLowerCase()) || o.desc.toLowerCase().includes(search.toLowerCase());
                return sMatch && tMatch;
            });

            if (list.length === 0) view.innerHTML += '<div style="text-align:center; color:#444; margin-top:40px;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';

            list.forEach((ord) => {
                let idx = DB.orders.indexOf(ord);
                
                // –î–µ–¥–ª–∞–π–Ω –ª–æ–≥–∏–∫–∞
                let isLate = (ord.status !== 'closed' && ord.status !== 'archived' && ord.date <= new Date().toISOString().split('T')[0]);
                let dateHTML = `<span class="${isLate ? 'deadline-hot' : ''}" style="font-size:0.8rem; color:#888;">üìÖ ${ord.date} ${isLate ? '(–°–†–û–ö!)' : ''}</span>`;

                // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                let actionBtn = '';
                if (ord.status === 'free') actionBtn = `<button style="background:#00ff00; color:black; width:auto; padding:5px 15px;" onclick="setStatus(${idx}, 'process')">–í–ó–Ø–¢–¨</button>`;
                else if (ord.status === 'process') actionBtn = `<button style="background:yellow; color:black; width:auto; padding:5px 15px;" onclick="setStatus(${idx}, 'closed')">–ó–ê–í–ï–†–®–ò–¢–¨</button>`;

                // –î–æ–ø. –∫–Ω–æ–ø–∫–∏ –¥–ª—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∞/–ú–µ–Ω–µ–¥–∂–µ—Ä–∞
                let adminBtns = '';
                if (['director', 'manager'].includes(currentUser.role) && ord.status !== 'archived') {
                    adminBtns = `
                        <button onclick="editOrder(${idx})" style="background:none; border:none; color:#aaa; font-size:0.8rem; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="setStatus(${idx}, 'archived')" style="background:none; border:none; color:#aaa; font-size:0.8rem; cursor:pointer;">üóëÔ∏è</button>
                    `;
                }

                // –ó–∞–º–µ—Ç–∫–∏
                let notesHTML = (ord.notes || []).map(n => `<div style="border-bottom:1px solid #222; padding:3px 0;">- ${n}</div>`).join('');

                view.innerHTML += `
                    <div class="order-card" style="${isLate ? 'border-color:#500;' : ''}">
                        <div class="order-header">
                            <div>
                                <h3 style="margin:0; display:flex; align-items:center; gap:10px;">${ord.client} ${adminBtns}</h3>
                                <div style="font-size:0.85rem; color:#aaa; margin-top:5px;">${ord.desc}</div>
                            </div>
                            <div class="price-tag">${ord.price} c</div>
                        </div>

                        <div class="notes-area">
                            ${notesHTML}
                            <div class="add-note" onclick="addNote(${idx})">+ –ó–∞–º–µ—Ç–∫–∞</div>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; border-top:1px solid #222; padding-top:10px;">
                            <div>
                                ${dateHTML}
                                <span class="status-badge st-${ord.status}" style="margin-left:10px;">${ord.status}</span>
                            </div>
                            ${actionBtn}
                        </div>
                    </div>
                `;
            });
        }

        /* --- 4. –°–û–ó–î–ê–ù–ò–ï –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï --- */
        function renderAddOrder() {
            document.getElementById('main-view').innerHTML = `
                <h2>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
                <input id="n-client" placeholder="–ö–ª–∏–µ–Ω—Ç">
                <input type="number" id="n-price" placeholder="–ë—é–¥–∂–µ—Ç (—Å–æ–º)" style="border-color:#ffd700;">
                <textarea id="n-desc" placeholder="–¢–ó..." style="width:100%; height:100px; background:#111; color:white; border:1px solid #333; padding:10px;"></textarea>
                <input type="date" id="n-date">
                <button class="btn-primary" onclick="addOrder()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
                <button class="btn-outline" onclick="renderOrders()">–û–¢–ú–ï–ù–ê</button>
            `;
        }

        function addOrder() {
            let client = document.getElementById('n-client').value;
            let price = document.getElementById('n-price').value || 0;
            let desc = document.getElementById('n-desc').value;
            let date = document.getElementById('n-date').value;
            if(!client || !date) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!', 'error'); return; }
            DB.orders.push({ client, price, desc, date, status: 'free', notes: [] });
            saveDB(); showToast('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω'); renderOrders();
        }

        function editOrder(idx) {
            let ord = DB.orders[idx];
            let newP = prompt('–ù–æ–≤–∞—è —Ü–µ–Ω–∞:', ord.price);
            let newD = prompt('–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:', ord.desc);
            if(newP !== null && newD !== null) {
                ord.price = newP; ord.desc = newD;
                saveDB(); renderOrders(currentFilter);
            }
        }

        function addNote(idx) {
            let txt = prompt("–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏:");
            if(txt) {
                if(!DB.orders[idx].notes) DB.orders[idx].notes = [];
                DB.orders[idx].notes.push(txt);
                saveDB(); renderOrders(currentFilter);
            }
        }

        function setStatus(idx, st) {
            DB.orders[idx].status = st;
            if(st === 'closed') {
                // –ò—â–µ–º —Ç–æ–≥–æ, –∫—Ç–æ –∑–∞–∫—Ä—ã–ª, –∏ –¥–∞–µ–º –æ–ø—ã—Ç (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                // –í –∏–¥–µ–∞–ª–µ: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å worker –≤ –∑–∞–∫–∞–∑–µ
                showToast('–ó–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç! +XP');
            }
            saveDB(); updateStats(); renderOrders(currentFilter);
        }

        /* --- 5. –°–û–¢–†–£–î–ù–ò–ö–ò –ò –†–ê–ù–ì–ò --- */
        function renderStaff() {
            const view = document.getElementById('main-view');
            view.innerHTML = '<h2>–†–µ–π—Ç–∏–Ω–≥ –ö–æ–º–∞–Ω–¥—ã</h2>';
            
            let sorted = [...DB.users].sort((a,b) => (b.xp||0) - (a.xp||0));

            sorted.forEach(u => {
                let rank = getRank(u.xp || 0);
                view.innerHTML += `
                    <div class="order-card" style="display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${rank.color}">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="avatar">${u.name[0]}</div>
                            <div>
                                <h3 style="margin:0">${u.name} <span class="rank-badge" style="background:${rank.color}; color:white;">${rank.name}</span></h3>
                                <p style="margin:0; color:#666; font-size:0.8rem;">${u.role} | XP: ${u.xp||0}</p>
                            </div>
                        </div>
                        ${currentUser.role === 'director' ? `<button onclick="fire('${u.phone}')" style="color:red; background:none; border:none; cursor:pointer;">‚ùå</button>` : ''}
                    </div>
                `;
            });
        }

        function getRank(xp) {
            if(xp >= 10) return { name: 'SENIOR', color: '#ff00ff' };
            if(xp >= 3) return { name: 'MIDDLE', color: '#0055ff' };
            return { name: 'JUNIOR', color: '#555' };
        }

        /* --- 6. –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò --- */
        function saveDB() { localStorage.setItem('sab_db_ultimate', JSON.stringify(DB)); }
        
        function updateStats() {
            document.getElementById('s-free').innerText = DB.orders.filter(o => o.status === 'free').length;
            document.getElementById('s-work').innerText = DB.orders.filter(o => o.status === 'process').length;
            document.getElementById('s-closed').innerText = DB.orders.filter(o => o.status === 'closed').length;
            let money = DB.orders.filter(o => o.status === 'closed').reduce((acc, v) => acc + Number(v.price), 0);
            document.getElementById('s-money').innerText = money + ' c';
        }

        function showToast(msg, type='ok') {
            let box = document.createElement('div');
            box.className = 'toast';
            box.innerHTML = (type==='error'?'‚ö†Ô∏è ':'‚úÖ ') + msg;
            box.style.borderLeft = type==='error'?'5px solid red':'5px solid green';
            document.getElementById('toast-container').appendChild(box);
            setTimeout(() => box.remove(), 3000);
        }

        function showReg() { document.getElementById('login-screen').style.display='none'; document.getElementById('reg-screen').style.display='flex'; }
        
        function doReg() {
            let n=document.getElementById('r-name').value;
            let p=document.getElementById('r-phone').value;
            let pass=document.getElementById('r-pass').value;
            if(p==='705163333' || DB.users.find(u=>u.phone===p)) { showToast('–ù–æ–º–µ—Ä –∑–∞–Ω—è—Ç', 'error'); return; }
            DB.u
