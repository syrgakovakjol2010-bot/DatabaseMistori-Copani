<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MISTORI COPANI | SYSTEM</title>
    <style>
        /* =========================================
           1. –î–ò–ó–ê–ô–ù (PLATINUM DARK)
           ========================================= */
        :root {
            --bg: #000000;
            --sidebar: #050505;
            --card: #0F0F0F;
            --border: #222;
            --text: #ffffff;
            --gray: #888888;
            --gold: #FFD700;
            --green: #00FF88;
            --red: #FF4444;
            --blue: #2979FF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- –ó–ê–°–¢–ê–í–ö–ê (LOADING) --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #222;
            border-top: 4px solid #fff; border-radius: 50%;
            animation: spin 1s infinite linear; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- –í–•–û–î --- */
        #auth-screen {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            width: 100%; max-width: 380px; background: var(--card);
            border: 1px solid var(--border); padding: 40px 30px;
            border-radius: 24px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        .logo { font-size: 3rem; font-weight: 900; letter-spacing: 8px; margin: 0; }
        .sub-logo { color: var(--gray); font-size: 0.75rem; letter-spacing: 2px; margin-bottom: 30px; text-transform: uppercase; }

        input, textarea {
            width: 100%; padding: 16px; margin: 8px 0;
            background: #151515; border: 1px solid #333;
            color: #fff; border-radius: 12px; font-size: 16px;
            transition: 0.3s;
        }
        input:focus { border-color: #fff; background: #000; }

        .btn {
            width: 100%; padding: 16px; border-radius: 12px;
            font-weight: 800; border: none; cursor: pointer;
            text-transform: uppercase; margin-top: 15px; font-size: 14px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: #fff; color: #000; }
        .btn-sec { background: transparent; border: 1px solid #333; color: var(--gray); }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #app { display: none; height: 100%; width: 100%; flex-direction: column; }

        /* –°–∞–π–¥–±–∞—Ä (–ü–ö) */
        .sidebar {
            width: 280px; background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 30px;
        }
        .nav-pc-btn {
            background: transparent; border: none; color: var(--gray);
            text-align: left; padding: 15px; width: 100%;
            font-weight: bold; font-size: 0.9rem; cursor: pointer;
            border-radius: 12px; transition: 0.2s; margin-bottom: 5px;
        }
        .nav-pc-btn.active, .nav-pc-btn:hover { background: #151515; color: #fff; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        .top-bar {
            height: 70px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; background: rgba(5,5,5,0.9); backdrop-filter: blur(10px);
        }
        .view-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card); border: 1px solid var(--border);
            padding: 22px; border-radius: 20px; margin-bottom: 15px;
            position: relative; transition: 0.3s;
        }
        .price-badge {
            position: absolute; top: 22px; right: 22px;
            color: var(--gold); border: 1px solid var(--gold);
            padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 0.9rem;
        }
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 6px;
            font-size: 0.65rem; text-transform: uppercase; font-weight: bold;
            border: 1px solid #333; margin-top: 10px;
        }

        /* –ß–∞—Ç */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .msgs-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg-me { align-self: flex-end; background: #fff; color: #000; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: #1a1a1a; color: #fff; border: 1px solid #333; border-bottom-left-radius: 4px; }
        .input-bar { display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border); background: #000; }

        /* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
        .mob-nav {
            display: none; position: fixed; bottom: 0; width: 100%;
            background: #080808; border-top: 1px solid var(--border);
            justify-content: space-around; padding: 12px 0; z-index: 1000;
        }
        .mob-btn {
            background: none; border: none; color: #555;
            font-size: 0.65rem; font-weight: bold; display: flex;
            flex-direction: column; align-items: center; gap: 5px;
        }
        .mob-btn.active { color: #fff; }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 900px) { .sidebar { display: none; } .mob-nav { display: flex; } }
        .hidden { display: none !important; }
        
        #error-alert { color: var(--red); font-size: 0.8rem; text-align: center; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; color:#666; letter-spacing:2px;">MISTORI COPANI</p>
        <div id="error-alert">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ë–∞–∑—É –î–∞–Ω–Ω—ã—Ö.</div>
    </div>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 class="logo">M.C.</h1>
            <p class="sub-logo">SYSTEM PLATINUM v50</p>
            
            <input type="text" id="ph" placeholder="–ù–æ–º–µ—Ä (705163333)">
            <input type="password" id="ps" placeholder="–ü–∞—Ä–æ–ª—å">
            
            <button class="btn btn-main" onclick="window.doLogin()">–í–û–ô–¢–ò</button>
            <p id="login-msg" style="color:var(--red); font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="app">
        <div class="sidebar">
            <h2 style="letter-spacing:3px; margin-bottom:40px;">MISTORI</h2>
            <button class="nav-pc-btn active" id="d-orders" onclick="nav('orders')">üì¶ –ó–ê–ö–ê–ó–´</button>
            <button class="nav-pc-btn" id="d-chat" onclick="nav('chat')">üí¨ –ß–ê–¢</button>
            <button class="nav-pc-btn" id="d-team" onclick="nav('team')">üë• –ö–û–ú–ê–ù–î–ê</button>
            <button class="nav-pc-btn" id="d-fin" onclick="nav('fin')">üìä –ö–ê–°–°–ê</button>
            <button class="nav-pc-btn" id="d-add" onclick="nav('add')" style="color:var(--green)">‚ûï –ù–û–í–´–ô</button>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div>
                    <b id="u-name">...</b> <br>
                    <small id="u-role" style="color:var(--green); font-size:0.6rem; text-transform:uppercase;">...</small>
                </div>
                <div style="font-weight:900; opacity:0.3; letter-spacing:2px;">ONLINE</div>
            </div>
            
            <div id="view" class="view-area"></div>
        </div>

        <div class="mob-nav">
            <button class="mob-btn active" id="m-orders" onclick="nav('orders')">üì¶<br>–ó–ê–ö–ê–ó–´</button>
            <button class="mob-btn" id="m-chat" onclick="nav('chat')">üí¨<br>–ß–ê–¢</button>
            <button class="mob-btn" id="m-add" onclick="nav('add')">‚ûï<br>–ù–û–í–´–ô</button>
            <button class="mob-btn" id="m-team" onclick="nav('team')">üë•<br>–õ–Æ–î–ò</button>
            <button class="mob-btn" id="m-fin" onclick="nav('fin')">üìä<br>–ö–ê–°–°–ê</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // üî• –í–ê–®–ò –ö–õ–Æ–ß–ò –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–´ üî•
        const firebaseConfig = {
            apiKey: "AIzaSyCaH7PIEizuk4BlYuOWqFADrxnc1t984mI",
            authDomain: "mistori-copani.firebaseapp.com",
            databaseURL: "https://mistori-copani-default-rtdb.firebaseio.com",
            projectId: "mistori-copani",
            storageBucket: "mistori-copani.firebasestorage.app",
            messagingSenderId: "1009680617583",
            appId: "1:1009680617583:web:59a2f6fb9856b8c8ebfd9a",
            measurementId: "G-SBZXK8JSX8"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            const connectedRef = ref(db, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    document.getElementById('loader').style.display = 'none';
                } else {
                    // –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ—Ç —Å–≤—è–∑–∏
                    setTimeout(() => document.getElementById('error-alert').style.display = 'block', 5000);
                }
            });
        } catch (e) {
            alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + e.message);
        }

        // –î–∞–Ω–Ω—ã–µ
        let ME = null;
        let DATA = { orders:{}, users:{}, chat:{} };

        // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
        window.doLogin = async () => {
            const p = document.getElementById('ph').value.trim();
            const s = document.getElementById('ps').value.trim();
            const msg = document.getElementById('login-msg');

            // –ú–∞—Å—Ç–µ—Ä-–≤—Ö–æ–¥ (–ß—Ç–æ–±—ã –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–≥–ª–∏ –∑–∞–π—Ç–∏)
            if(p === '705163333' && s === 'admin123') return loginSuccess({name:"–ê–∫–∂–æ–ª", phone:p, role:"director"});
            if(p === '777800603' && s === 'admin2') return loginSuccess({name:"–°–µ–∑–∏–º", phone:p, role:"manager"});

            // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–∞–∑—É
            try {
                const snap = await get(child(ref(db), `users/${p}`));
                if (snap.exists()) {
                    const u = snap.val();
                    if(u.pass === s) loginSuccess(u);
                    else msg.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
                } else {
                    // –ê–≤—Ç–æ-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –≤–∞—Å –Ω–µ—Ç –≤ –±–∞–∑–µ)
                    if(confirm("–ù–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) {
                        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
                        if(name) {
                            const newUser = { name, phone: p, pass: s, role: "programmer", xp: 0 };
                            loginSuccess(newUser);
                        }
                    }
                }
            } catch(e) {
                msg.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        };

        function loginSuccess(user) {
            ME = user;
            update(ref(db, 'users/' + ME.phone), ME); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('u-name').innerText = ME.name;
            document.getElementById('u-role').innerText = ME.role.toUpperCase();
            
            nav('orders');
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        window.nav = (screen) => {
            const v = document.getElementById('view');
            
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-pc-btn, .mob-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById('d-'+screen)) document.getElementById('d-'+screen).classList.add('active');
            if(document.getElementById('m-'+screen)) document.getElementById('m-'+screen).classList.add('active');
            
            v.innerHTML = '';
            if(screen === 'orders') renderOrders(v);
            if(screen === 'chat') renderChat(v);
            if(screen === 'add') renderAdd(v);
            if(screen === 'team') renderTeam(v);
            if(screen === 'fin') renderFin(v);
        };

        // --- –≠–ö–†–ê–ù–´ ---
        function renderOrders(el) {
            el.innerHTML = '<div id="list"></div>';
            const arr = Object.entries(DATA.orders || {}).reverse();
            
            if(arr.length === 0) { document.getElementById('list').innerHTML = '<p style="text-align:center; color:#555; margin-top:50px">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>'; return; }

            arr.forEach(([key, o]) => {
                if(o.status === 'archive') return;
                
                let btns = '';
                if(o.status === 'new') btns = `<button class="btn btn-main" style="background:var(--green); border:none; padding:8px 15px; border-radius:8px;" onclick="window.upd('${key}','work')">–í–ó–Ø–¢–¨</button>`;
                if(o.status === 'work') btns = `<button class="btn btn-main" style="background:var(--gold); border:none; padding:8px 15px; border-radius:8px;" onclick="window.upd('${key}','done')">–ì–û–¢–û–í–û</button>`;
                
                document.getElementById('list').innerHTML += `
                    <div class="card" style="${o.status==='reject'?'opacity:0.5':''}">
                        <div class="price-badge">${o.price} —Å</div>
                        <h3 style="margin:0">${o.client}</h3>
                        <p style="color:#aaa; font-size:0.9rem; margin:10px 0;">${o.desc}</p>
                        ${o.ref ? `<div style="background:#1a1a1a; padding:8px; border-radius:6px; font-size:0.8rem; color:var(--blue); margin-bottom:10px;">üîó ${o.ref}</div>` : ''}
                        
                        <div style="font-size:0.6rem; text-transform:uppercase; color:#666; margin-bottom:15px;">–°—Ç–∞—Ç—É—Å: ${o.status}</div>
                        
                        <div style="display:flex; gap:10px;">
                            ${btns}
                            ${ME.role === 'director' ? `<button onclick="window.upd('${key}','archive')" style="background:none; border:none; color:var(--red);">DEL</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function renderChat(el) {
            el.innerHTML = `<div class="chat-container"><div class="msgs-area" id="feed"></div><div class="input-bar"><input id="msg" placeholder="..." style="margin:0"><button class="btn btn-main" style="width:50px; margin:0" onclick="window.send()">></button></div></div>`;
            setTimeout(drawChat, 100);
        }
        function drawChat() {
            const f = document.getElementById('feed');
            if(!f) return;
            f.innerHTML = '';
            Object.values(DATA.chat || {}).forEach(m => {
                f.innerHTML += `<div class="msg ${m.user===ME.name?'msg-me':'msg-other'}"><small style="opacity:0.5; font-size:0.6rem;">${m.user}</small><br>${m.text}</div>`;
            });
            f.scrollTop = f.scrollHeight;
        }

        function renderAdd(el) {
            if(ME.role === 'programmer') { el.innerHTML='<center style="margin-top:50px">–ù–µ—Ç –ø—Ä–∞–≤</center>'; return; }
            el.innerHTML = `<h3>–ù–û–í–´–ô –ó–ê–ö–ê–ó</h3><input id="c" placeholder="–ö–ª–∏–µ–Ω—Ç"><input id="p" type="number" placeholder="–ë—é–¥–∂–µ—Ç"><textarea id="d" placeholder="–¢–ó"></textarea><input id="r" placeholder="–†–µ—Ñ–µ—Ä–µ–Ω—Å"><button class="btn btn-main" onclick="window.add()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>`;
        }

        function renderTeam(el) {
            el.innerHTML = '<h3>–ö–û–ú–ê–ù–î–ê</h3>';
            Object.values(DATA.users || {}).forEach(u => {
                el.innerHTML += `<div class="card"><b>${u.name}</b> (${u.role})<br><small>${u.phone}</small></div>`;
            });
        }

        function renderFin(el) {
            const sum = Object.values(DATA.orders || {}).filter(o=>o.status==='done').reduce((a,b)=>a+Number(b.price),0);
            el.innerHTML = `<center style="margin-top:50px"><small>–û–ë–©–ê–Ø –ü–†–ò–ë–´–õ–¨</small><h1 style="color:var(--gold); font-size:3rem;">${sum} —Å</h1></center>`;
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø ---
        window.add = () => {
            const c=document.getElementById('c').value, p=document.getElementById('p').value, d=document.getElementById('d').value, r=document.getElementById('r').value;
            if(c && p) { push(ref(db, 'orders'), {client:c, price:p, desc:d, ref:r, status:'new'}); nav('orders'); }
        };
        window.upd = (k, s) => update(ref(db, 'orders/'+k), {status:s});
        window.send = () => { const t=document.getElementById('msg').value; if(t) { push(ref(db,'chat'),{user:ME.name, text:t}); document.getElementById('msg').value=''; } };

        // --- –°–õ–£–®–ê–¢–ï–õ–ò (REALTIME) ---
        function startListeners() {
            onValue(ref(db), (snap) => {
                const val = snap.val();
                if(val) DATA = val;
                
                // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
                const act = document.querySelector('.nav-pc-btn.active, .mob-btn.active');
                if(act && ME) {
                    const id = act.id.split('-')[1];
                    if(id==='orders') renderOrders(document.getElementById('view'));
                    if(id==='chat') drawChat();
                    if(id==='team') renderTeam(document.getElementById('view'));
                    if(id==='fin') renderFin(document.getElementById('view'));
                }
            });
        }
        startListeners();

    </script>
</body>
</html>
